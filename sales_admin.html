{% extends "admin_base.html" %}

{% block title %}Ankauf Verwaltung | AO Mobile{% endblock %}

{% block styles %}
<style>
    /* Wrapper für max-width */
    .sales-wrapper { max-width: 1000px; margin: 0 auto; }

    /* Tabs */
    .tab-nav { display: flex; gap: 20px; border-bottom: 2px solid #ddd; margin-bottom: 30px; margin-top: 20px; }
    .tab-btn { 
        padding: 15px 20px; cursor: pointer; font-weight: 600; color: #777; 
        border-bottom: 3px solid transparent; margin-bottom: -2px; transition: 0.2s;
    }
    .tab-btn.active { color: #007bff; border-bottom-color: #007bff; }
    
    .tab-content { display: none; animation: fadeIn 0.3s; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* Karte */
    .sale-card { 
        background: white; border-radius: 12px; padding: 25px; margin-bottom: 20px; 
        box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 6px solid #ccc; 
    }
    
    .status-Pruefung { border-left-color: #ffc107; } /* Gelb - In Prüfung */
    .status-Angenommen { border-left-color: #28a745; } /* Grün - Geld ausgezahlt */
    .status-Abgelehnt { border-left-color: #ea4335; opacity: 0.7; } /* Rot */

    .card-header { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .sale-id { font-weight: 700; font-size: 18px; }
    
    .grid-info { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }
    
    .info-box { background: #f9f9f9; padding: 15px; border-radius: 8px; font-size: 14px; border: 1px solid #eee; }
    .info-box h4 { margin: 0 0 5px 0; color: #555; font-size: 12px; text-transform: uppercase; }

    .price-tag { font-size: 24px; font-weight: 700; color: #28a745; text-align: right; }
    
    .btn-group { display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px; }
    .btn { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 14px; color: white; }
    
    .btn-accept { background: #28a745; }
    .btn-accept:hover { background: #218838; }
    
    .btn-reject { background: #ea4335; }
    .btn-reject:hover { background: #c82333; }

    .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
</style>
{% endblock %}

{% block content %}
<div class="sales-wrapper">
    <h1 style="margin:0;">Ankauf-Eingang</h1>
    
    <div class="tab-nav">
        <div class="tab-btn active" onclick="switchTab('open')">Offene Anfragen</div>
        <div class="tab-btn" onclick="switchTab('closed')">Abgeschlossen / Archiv</div>
    </div>

    <div id="tab-open" class="tab-content active">
        <div id="list-open">Lade...</div>
    </div>

    <div id="tab-closed" class="tab-content">
        <div id="list-closed">Lade...</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function loadSales() {
        const res = await fetch('/api/admin/sales');
        const sales = await res.json();
        
        const listOpen = document.getElementById('list-open');
        const listClosed = document.getElementById('list-closed');
        
        listOpen.innerHTML = '';
        listClosed.innerHTML = '';

        let countOpen = 0;

        sales.forEach(sale => {
            const isClosed = sale.status === 'Angenommen' || sale.status === 'Abgelehnt';
            let statusClass = 'status-Pruefung';
            if(sale.status === 'Angenommen') statusClass = 'status-Angenommen';
            if(sale.status === 'Abgelehnt') statusClass = 'status-Abgelehnt';

            if(!isClosed) countOpen++;

            // HTML Karte bauen
            const html = `
                <div class="sale-card ${statusClass}">
                    <div class="card-header">
                        <div>
                            <span class="sale-id">${sale.sale_id}</span>
                            <span class="badge" style="background:#eee; margin-left:10px;">${sale.status}</span>
                        </div>
                        <span style="color:#777; font-size:14px;">${sale.date}</span>
                    </div>

                    <div class="grid-info">
                        <div class="info-box">
                            <h4>Gerät & Zustand</h4>
                            <div style="font-size:16px; font-weight:600; margin-bottom:5px;">${sale.device}</div>
                            <div>Speicher: ${sale.specs.storage}</div>
                            <div>Zustand: ${sale.specs.condition}</div>
                            <div>Akku: ${sale.specs.battery}</div>
                        </div>
                        <div class="info-box">
                            <h4>Kunde / Verkäufer</h4>
                            <div style="margin-bottom:5px;">${sale.user_email}</div>
                            <div class="price-tag">${sale.offer_price} CHF</div>
                            <div style="text-align:right; font-size:12px; color:#777;">Auszuzahlen</div>
                        </div>
                    </div>

                    ${!isClosed ? `
                    <div class="btn-group">
                        <button class="btn btn-reject" onclick="updateStatus('${sale.sale_id}', 'Abgelehnt')">❌ Ablehnen</button>
                        <button class="btn btn-accept" onclick="updateStatus('${sale.sale_id}', 'Angenommen')">✅ Gerät erhalten & Auszahlen</button>
                    </div>
                    ` : ''}
                </div>
            `;

            if (isClosed) listClosed.innerHTML += html;
            else listOpen.innerHTML += html;
        });

        if (listOpen.innerHTML === '') listOpen.innerHTML = '<div style="text-align:center; padding:40px; color:#999;">Keine offenen Anfragen.</div>';
    }

    async function updateStatus(id, newStatus) {
        if(!confirm(`Status wirklich auf "${newStatus}" setzen?`)) return;

        await fetch('/api/admin/sales', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ sale_id: id, status: newStatus })
        });
        
        loadSales(); // Neu laden
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tabName).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    // Start
    loadSales();
</script>
{% endblock %}