{% extends "base.html" %}

{% block title %}Handy verkaufen | AO Mobile{% endblock %}

{% block styles %}
<style>
    /* Spezifische Styles für den Verkauf-Wizard */
    .container { max-width: 800px; margin: 0 auto; padding: 40px 20px; }
    
    .wizard-container { 
        background: white; 
        border-radius: 24px; 
        padding: 40px; 
        box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
        min-height: 400px; 
        color: #333;
    }
    
    .wizard-step { display: none; }
    .wizard-step.active { display: block; animation: fadeIn 0.4s; }
    
    .wizard-grid { 
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 15px; 
        margin-top: 20px; 
    }
    
    .wizard-card { 
        background: #f9f9f9; 
        padding: 20px; 
        border-radius: 16px; 
        text-align: center; 
        cursor: pointer; 
        border: 2px solid transparent; 
        transition: 0.2s; 
    }
    .wizard-card:hover { border-color: var(--primary-color); background: #f0f0f0; }
    .wizard-card img { width: 60px; height: 60px; object-fit: contain; margin-bottom: 10px; }

    .option-title { font-size: 16px; font-weight: 600; margin-top: 20px; margin-bottom: 10px; }
    .pill-container { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
    
    .pill { 
        padding: 10px 20px; 
        border: 1px solid #ddd; 
        border-radius: 30px; 
        background: white; 
        cursor: pointer; 
        font-size: 14px; 
        transition: 0.2s;
    }
    .pill.active { border: 2px solid var(--primary-color); font-weight: 600; background: #e3f2fd; color: var(--primary-color); }

    .btn-full { 
        display: block; 
        width: 100%; 
        padding: 15px; 
        background: var(--primary-gradient); 
        color: white; 
        border: none; 
        border-radius: 30px; 
        font-weight: 600; 
        cursor: pointer; 
        margin-top: 30px; 
        text-transform: uppercase; 
        box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
    }
    
    #final-price-box { 
        text-align: center; 
        margin-top: 30px; 
        padding: 40px; 
        background: #f0f7ff; 
        border-radius: 20px; 
        border: 1px solid #e3f2fd;
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @media (max-width: 600px) { .wizard-grid { grid-template-columns: 1fr; } }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="wizard-container">
        <div class="wizard-step active" id="step-brand">
            <h2>Welche Marke hat dein Handy?</h2>
            <div id="brand-grid" class="wizard-grid"></div>
        </div>

        <div class="wizard-step" id="step-model">
            <button onclick="showStep('step-brand')" style="background:none; border:none; color:var(--primary-color); cursor:pointer; margin-bottom:15px;">← Zurück</button>
            <h2>Welches Modell ist es?</h2>
            <div id="model-grid" class="wizard-grid"></div>
        </div>

        <div class="wizard-step" id="step-specs">
            <button onclick="showStep('step-model')" style="background:none; border:none; color:var(--primary-color); cursor:pointer; margin-bottom:15px;">← Zurück</button>
            <h2 id="spec-title">Geräte Details</h2>
            <div id="specs-content">
                <div class="option-title">Speicherkapazität</div>
                <div id="storage-pills" class="pill-container"></div>

                <div class="option-title">Zustand des Geräts</div>
                <div id="condition-pills" class="pill-container"></div>
            </div>
            <button class="btn-full" onclick="calculateValue()">Wert berechnen</button>
        </div>

        <div class="wizard-step" id="step-result">
            <h2>Dein persönliches Angebot</h2>
            <div id="final-price-box">
                <div id="final-price" style="font-size: 54px; font-weight: 700; color: var(--primary-color);">0 CHF</div>
                <p style="color:#555; margin-top:10px;">Voraussichtlicher Auszahlungsbetrag</p>
            </div>
            <p style="text-align:center; font-size:13px; color:#999; margin-top:20px;">
                Nach Erhalt und Prüfung deines Geräts überweisen wir den Betrag direkt auf dein Konto.
            </p>
            <button class="btn-full" onclick="location.href='/'">Zurück zum Start</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let sellData = {};
    let selectedProduct = null;
    let selectedStorage = null;
    let selectedCondition = null;

    // Daten beim Start laden
    fetch('/data/sell.json?v=' + new Date().getTime())
        .then(r => r.json())
        .then(data => {
            sellData = data;
            const grid = document.getElementById('brand-grid');
            for (let brand in sellData) {
                const div = document.createElement('div');
                div.className = 'wizard-card';
                div.onclick = () => renderModels(brand);
                div.innerHTML = `
                    <img src="${sellData[brand].logo}" onerror="this.src='https://via.placeholder.com/60'">
                    <div style="font-weight:500;">${brand}</div>
                `;
                grid.appendChild(div);
            }
        });

    function renderModels(brand) {
        const grid = document.getElementById('model-grid');
        grid.innerHTML = '';
        sellData[brand].products.forEach(p => {
            const div = document.createElement('div');
            div.className = 'wizard-card';
            div.onclick = () => renderSpecs(p);
            div.innerHTML = `<div style="font-weight:500;">${p.name}</div>`;
            grid.appendChild(div);
        });
        showStep('step-model');
    }

    function renderSpecs(p) {
        selectedProduct = p;
        document.getElementById('spec-title').innerText = p.name;
        
        // Speicher Pills
        const sContainer = document.getElementById('storage-pills');
        sContainer.innerHTML = '';
        p.storageOptions.forEach((opt, i) => {
            const span = document.createElement('span');
            span.className = 'pill';
            if(i === 0) { span.classList.add('active'); selectedStorage = opt; }
            span.innerText = opt.name;
            span.onclick = () => {
                sContainer.querySelectorAll('.pill').forEach(el => el.classList.remove('active'));
                span.classList.add('active');
                selectedStorage = opt;
            };
            sContainer.appendChild(span);
        });

        // Zustand Pills
        const cContainer = document.getElementById('condition-pills');
        cContainer.innerHTML = '';
        p.conditions.forEach((opt, i) => {
            const span = document.createElement('span');
            span.className = 'pill';
            if(i === 0) { span.classList.add('active'); selectedCondition = opt; }
            span.innerText = opt.name;
            span.onclick = () => {
                cContainer.querySelectorAll('.pill').forEach(el => el.classList.remove('active'));
                span.classList.add('active');
                selectedCondition = opt;
            };
            cContainer.appendChild(span);
        });

        showStep('step-specs');
    }

    function calculateValue() {
        if (!selectedProduct || !selectedStorage || !selectedCondition) return;
        
        let val = selectedProduct.basePrice + selectedStorage.price + selectedCondition.price;
        if(val < 0) val = 0; // Kein Minus-Ankaufspreis

        document.getElementById('final-price').innerText = val + " CHF";
        showStep('step-result');
    }

    function showStep(id) {
        document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo(0,0);
    }
</script>
{% endblock %}