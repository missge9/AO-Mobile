<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lager & Produkt Manager | AO Mobile</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #007bff; --bg: #f4f7f6; --border: #ddd; --danger: #ea4335; --success: #28a745; --dark: #343a40; }
        * { box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background: var(--bg); padding: 20px; margin: 0; height: 100vh; display: flex; flex-direction: column; }
        
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .container { display: flex; gap: 20px; flex-grow: 1; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 320px; background: white; border-radius: 12px; padding: 20px; display: flex; flex-direction: column; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .editor-area { flex-grow: 1; background: white; border-radius: 12px; padding: 0; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: none; flex-direction: column; }
        .editor-area.active { display: flex; }
        .editor-scroll { padding: 30px; overflow-y: auto; flex-grow: 1; }

        /* Listen */
        .list-item { 
            padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; 
            transition: 0.2s; border-radius: 6px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center;
        }
        .list-item:hover { background: #f9f9f9; }
        .list-item.active { background: #e3f2fd; color: var(--primary); font-weight: 500; }
        
        /* Formulare Allgemein */
        h2 { margin-top: 0; color: var(--primary); border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }
        h3 { font-size: 15px; margin-top: 25px; margin-bottom: 10px; color: #555; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        label { display: block; font-size: 12px; color: #777; margin-bottom: 4px; }
        input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; }

        /* Tabellen Editor (Konfiguration) */
        .variant-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        .variant-table th { text-align: left; background: #f9f9f9; padding: 8px; font-size: 12px; color: #666; }
        .variant-table td { padding: 5px; border-bottom: 1px solid #eee; }
        .variant-table input { border: 1px solid transparent; background: transparent; width: 100%; }
        .variant-table input:focus { border-color: var(--primary); background: white; }

        /* --- NEUES DESIGN F√úR INVENTAR --- */
        
        /* 1. Die Liste unten */
        .inventory-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; margin-top: 20px; font-size: 13px; }
        .inventory-table th { text-align: left; padding: 10px; color: #666; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        .inventory-table tr { background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .inventory-table td { padding: 12px 10px; border-top: 1px solid #eee; border-bottom: 1px solid #eee; vertical-align: middle; }
        .inventory-table td:first-child { border-left: 1px solid #eee; border-radius: 8px 0 0 8px; }
        .inventory-table td:last-child { border-right: 1px solid #eee; border-radius: 0 8px 8px 0; }

        /* 2. Der "Gro√üe Plus Button" Bereich */
        .add-inventory-card {
            border: 2px dashed #ccc;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            color: #777;
            background: #fafafa;
            margin-bottom: 30px;
        }
        .add-inventory-card:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: #f0f7ff;
        }
        .add-icon { font-size: 40px; line-height: 40px; margin-bottom: 10px; display: block; }
        
        /* 3. Das Ausklapp-Formular */
        .add-inventory-form {
            display: none; /* Versteckt am Anfang */
            background: white;
            border: 1px solid #007bff;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,123,255,0.1);
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* Buttons & Badges */
        .btn { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-size: 14px; font-weight: 500; transition: 0.2s; }
        .btn-save { background: var(--success); color: white; padding: 12px 24px; font-size: 16px; box-shadow: 0 4px 10px rgba(40, 167, 69, 0.2); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-add { background: var(--primary); color: white; width: 100%; margin-top: 10px; font-weight: 600; padding: 15px; }
        .btn-small { background: #eee; color: #333; padding: 4px 10px; font-size: 12px; border-radius: 4px; border:none; cursor:pointer;}
        
        .stock-badge { background: #e3f2fd; color: #007bff; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .id-badge { background: #343a40; color: #fff; padding: 4px 8px; border-radius: 4px; font-family: monospace; font-size: 12px; }

        /* Tabs Navigation */
        .tab-nav { display: flex; border-bottom: 1px solid #eee; background: #fafafa; padding: 0 20px; }
        .tab-btn { padding: 15px 20px; cursor: pointer; color: #666; font-weight: 500; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-content { display: none; padding-top: 20px; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>

    <header>
        <div>
            <h1 style="margin:0; font-size:24px;">Lager & Produkte</h1>
            <a href="/" style="color:#666; text-decoration:none; font-size:14px;">Zur√ºck zum Shop</a>
        </div>
        <button class="btn btn-save" onclick="saveToServer()">Alles Speichern</button>
    </header>

    <div class="container">
        <div class="sidebar">
            <select id="brand-select" onchange="renderProductList()" style="margin-bottom:15px;">
                <option value="">Alle Marken anzeigen</option>
            </select>

            <div id="product-list" style="overflow-y: auto; flex-grow: 1;">
                </div>
            
            <button class="btn btn-add" onclick="addNewProduct()">+ Neue Modell-Serie</button>
        </div>

        <div id="editor" class="editor-area">
            <div class="tab-nav">
                <div class="tab-btn active" onclick="switchTab('tab-inventory')">üì¶ Lagerbestand & Ger√§te</div>
                <div class="tab-btn" onclick="switchTab('tab-config')">‚öôÔ∏è Konfiguration & Preise</div>
            </div>

            <div class="editor-scroll">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                    <h2 style="border:none; margin:0;" id="edit-title">Produkt</h2>
                </div>

                <div id="tab-inventory" class="tab-content active">
                    
                    <h3>Lagerbestand & neue Ger√§te hinzuf√ºgen</h3>

                    <div id="add-trigger" class="add-inventory-card" onclick="toggleAddForm()">
                        <span class="add-icon">+</span>
                        <div>Ger√§t hinzuf√ºgen</div>
                    </div>

                    <div id="add-form" class="add-inventory-form">
                        <h4 style="margin-top:0; color:#007bff;">Neues Ger√§t konfigurieren</h4>
                        
                        <div class="form-row">
                            <div>
                                <label>Speichergr√∂√üe</label>
                                <select id="new-storage"></select>
                            </div>
                            <div>
                                <label>Farbe</label>
                                <select id="new-color"></select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div>
                                <label>Optischer Zustand</label>
                                <select id="new-condition"></select>
                            </div>
                            <div>
                                <label>Akku Zustand</label>
                                <select id="new-battery"></select>
                            </div>
                        </div>

                        <div style="text-align:right; margin-top:20px;">
                            <button class="btn" style="background:#eee; color:#333; margin-right:10px;" onclick="toggleAddForm()">Abbrechen</button>
                            <button class="btn btn-primary" onclick="commitNewInventoryItem()">Ger√§t Hinzuf√ºgen</button>
                        </div>
                    </div>

                    <h4 style="margin-bottom:5px; color:#555;">Aktueller Bestand</h4>
                    <table class="inventory-table">
                        <thead>
                            <tr>
                                <th style="width:80px">ID</th>
                                <th>Details</th>
                                <th>Zustand</th>
                                <th>Preis</th>
                                <th style="width:50px"></th>
                            </tr>
                        </thead>
                        <tbody id="inventory-list">
                            </tbody>
                    </table>
                </div>

                <div id="tab-config" class="tab-content">
                    <p style="background:#fff3cd; padding:10px; border-radius:6px; color:#856404; font-size:13px;">
                        ‚ö†Ô∏è Hier definierst du, welche Optionen (Farben, Speicher) f√ºr dieses Modell <b>generell existieren</b>. <br>
                        Erst wenn du sie hier anlegst, kannst du sie im anderen Tab ausw√§hlen.
                    </p>

                    <div class="form-row">
                        <div><label>Modell Name</label><input type="text" id="inp-name" oninput="updateCurrentProduct('name', this.value)"></div>
                        <div><label>Basis Preis (CHF)</label><input type="number" id="inp-basePrice" oninput="updateCurrentProduct('basePrice', this.value)"></div>
                    </div>
                    <div class="form-row">
                        <div><label>Bild URL</label><input type="text" id="inp-img" oninput="updateCurrentProduct('img', this.value)"></div>
                        <div><label>Rabatt Badge</label><input type="text" id="inp-discount" oninput="updateCurrentProduct('discount', this.value)"></div>
                    </div>

                    <h3>Farben (Generell)</h3>
                    <div id="color-container"></div>
                    <button class="btn-small" onclick="addItem('colors')">+ Farbe Option</button>

                    <h3>Speicher (Generell)</h3>
                    <div id="storage-container"></div>
                    <button class="btn-small" onclick="addItem('storageOptions')">+ Speicher Option</button>

                    <h3>Zustand (Generell)</h3>
                    <div id="optical-container"></div>
                    <button class="btn-small" onclick="addItem('opticalConditions')">+ Zustand Option</button>
                    
                    <h3>Akku (Generell)</h3>
                    <div id="battery-container"></div>
                    <button class="btn-small" onclick="addItem('batteryConditions')">+ Akku Option</button>
                    
                    <div style="margin-top:50px; text-align:right;">
                        <button style="color:#ea4335; background:none; border:none; cursor:pointer; text-decoration:underline;" onclick="deleteProduct()">Modell-Serie l√∂schen</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let shopData = {};
        let currentBrand = null;
        let currentProductIndex = -1;

        // Daten laden
        fetch('/api/admin/data')
            .then(r => r.json())
            .then(data => {
                shopData = data;
                initBrands();
                renderProductList();
            });

        function initBrands() {
            const select = document.getElementById('brand-select');
            select.innerHTML = '<option value="">Alle Marken</option>';
            for (let brand in shopData) {
                let opt = document.createElement('option');
                opt.value = brand; opt.innerText = brand;
                select.appendChild(opt);
            }
        }

        function renderProductList() {
            const filterBrand = document.getElementById('brand-select').value;
            const list = document.getElementById('product-list');
            list.innerHTML = '';

            for (let brand in shopData) {
                if (filterBrand && brand !== filterBrand) continue;

                shopData[brand].products.forEach((prod, index) => {
                    if(!prod.id) prod.id = generateId('MOD');
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    const stock = prod.inventory ? prod.inventory.length : 0;
                    div.innerHTML = `<div>${prod.name}</div><span class="stock-badge">${stock} Stk.</span>`;
                    div.onclick = () => loadEditor(brand, index);
                    if(currentBrand === brand && currentProductIndex === index) div.classList.add('active');
                    list.appendChild(div);
                });
            }
        }

        function loadEditor(brand, index) {
            currentBrand = brand;
            currentProductIndex = index;
            const p = shopData[brand].products[index];

            document.getElementById('editor').classList.add('active');
            renderProductList(); 

            document.getElementById('edit-title').innerText = p.name;
            
            // Konfiguration Laden
            document.getElementById('inp-name').value = p.name || '';
            document.getElementById('inp-basePrice').value = p.basePrice || 0;
            document.getElementById('inp-img').value = p.img || '';
            document.getElementById('inp-discount').value = p.discount || '';

            renderTable('optical-container', p.opticalConditions, 'opticalConditions');
            renderTable('storage-container', p.storageOptions, 'storageOptions');
            renderTable('battery-container', p.batteryConditions, 'batteryConditions');
            renderColorTable('color-container', p.colors);

            // INVENTAR LADEN
            renderInventoryTable(p);
            
            // Formular zur√ºcksetzen beim Laden
            document.getElementById('add-trigger').style.display = 'block';
            document.getElementById('add-form').style.display = 'none';
        }

        // --- NEW INVENTAR LOGIK ---
        
        // 1. Ausklappen
        function toggleAddForm() {
            const trigger = document.getElementById('add-trigger');
            const form = document.getElementById('add-form');
            
            if (form.style.display === 'none') {
                // √ñffnen
                populateAddDropdowns(); // Dropdowns f√ºllen
                trigger.style.display = 'none';
                form.style.display = 'block';
            } else {
                // Schlie√üen
                trigger.style.display = 'block';
                form.style.display = 'none';
            }
        }

        // 2. Dropdowns mit den Optionen f√ºllen
        function populateAddDropdowns() {
            const p = shopData[currentBrand].products[currentProductIndex];
            
            fillSelect('new-storage', p.storageOptions);
            fillSelect('new-color', p.colors);
            fillSelect('new-condition', p.opticalConditions);
            fillSelect('new-battery', p.batteryConditions);
        }

        function fillSelect(id, options) {
            const sel = document.getElementById(id);
            sel.innerHTML = '';
            if(!options || options.length === 0) {
                sel.innerHTML = '<option>Keine Option definiert</option>';
                return;
            }
            options.forEach(opt => {
                const op = document.createElement('option');
                op.value = opt.name;
                op.innerText = opt.name;
                sel.appendChild(op);
            });
        }

        // 3. Hinzuf√ºgen zur Liste
        function commitNewInventoryItem() {
            const p = shopData[currentBrand].products[currentProductIndex];
            
            const newItem = {
                id: Math.floor(1000 + Math.random() * 9000),
                storage: document.getElementById('new-storage').value,
                color: document.getElementById('new-color').value,
                condition: document.getElementById('new-condition').value,
                battery: document.getElementById('new-battery').value
            };
            
            if(!p.inventory) p.inventory = [];
            p.inventory.push(newItem);
            
            renderInventoryTable(p);
            renderProductList(); // Stock count update
            toggleAddForm(); // Formular wieder schlie√üen
        }

        // 4. Tabelle rendern
        function renderInventoryTable(product) {
            const tbody = document.getElementById('inventory-list');
            tbody.innerHTML = '';
            
            if (!product.inventory || product.inventory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px; color:#999;">Noch keine Ger√§te an Lager.</td></tr>';
                return;
            }

            product.inventory.forEach((item, idx) => {
                const tr = document.createElement('tr');
                const price = calculatePrice(product, item);
                
                tr.innerHTML = `
                    <td><span class="id-badge">#${item.id}</span></td>
                    <td>
                        <strong>${item.color}</strong>, ${item.storage}
                    </td>
                    <td>
                        ${item.condition} <br> <span style="font-size:11px; color:#999;">Akku: ${item.battery}</span>
                    </td>
                    <td>
                        <div style="font-weight:bold; color:#28a745;">${price} CHF</div>
                    </td>
                    <td style="text-align:right;">
                        <button style="color:#ea4335; background:none; border:none; cursor:pointer;" onclick="removeInventoryItem(${idx})">&times;</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function removeInventoryItem(idx) {
            if(confirm("Ger√§t entfernen?")) {
                shopData[currentBrand].products[currentProductIndex].inventory.splice(idx, 1);
                renderInventoryTable(shopData[currentBrand].products[currentProductIndex]);
                renderProductList();
            }
        }

        function calculatePrice(product, item) {
            let price = parseInt(product.basePrice || 0);
            const findPrice = (list, name) => {
                const found = list ? list.find(x => x.name === name) : null;
                return found ? parseInt(found.price || 0) : 0;
            };
            price += findPrice(product.storageOptions, item.storage);
            price += findPrice(product.colors, item.color);
            price += findPrice(product.opticalConditions, item.condition);
            price += findPrice(product.batteryConditions, item.battery);
            return price;
        }

        // --- KONFIGURATION RENDERER ---
        function renderTable(containerId, dataArray, keyName) {
            const container = document.getElementById(containerId);
            if(!dataArray) dataArray = [];
            let html = `<table class="variant-table"><thead><tr><th style="width:50%">Bezeichnung</th><th>Preis (+/-)</th><th></th></tr></thead><tbody>`;
            dataArray.forEach((item, idx) => {
                html += `<tr>
                    <td><input type="text" value="${item.name}" onchange="updateArrayItem('${keyName}', ${idx}, 'name', this.value)"></td>
                    <td><input type="number" value="${item.price}" onchange="updateArrayItem('${keyName}', ${idx}, 'price', this.value)"></td>
                    <td style="text-align:right;"><button style="color:#ea4335; background:none; border:none; cursor:pointer;" onclick="removeArrayItem('${keyName}', ${idx})">&times;</button></td>
                </tr>`;
            });
            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        function renderColorTable(containerId, dataArray) {
            const container = document.getElementById(containerId);
            if(!dataArray) dataArray = [];
            let html = `<table class="variant-table"><thead><tr><th style="width:30%">Farbe</th><th style="width:20%">Hex</th><th style="width:20%">Preis</th><th></th></tr></thead><tbody>`;
            dataArray.forEach((item, idx) => {
                html += `<tr>
                    <td><input type="text" value="${item.name}" onchange="updateArrayItem('colors', ${idx}, 'name', this.value)"></td>
                    <td><div style="display:flex;align-items:center;"><div style="width:15px;height:15px;border-radius:50%;background:${item.hex};border:1px solid #ddd;margin-right:5px;"></div><input type="text" value="${item.hex}" onchange="updateArrayItem('colors', ${idx}, 'hex', this.value)"></div></td>
                    <td><input type="number" value="${item.price}" onchange="updateArrayItem('colors', ${idx}, 'price', this.value)"></td>
                    <td style="text-align:right;"><button style="color:#ea4335; background:none; border:none; cursor:pointer;" onclick="removeArrayItem('colors', ${idx})">&times;</button></td>
                </tr>`;
            });
            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        // --- UPDATES ---
        function updateCurrentProduct(field, value) {
            shopData[currentBrand].products[currentProductIndex][field] = value;
            if(field === 'name') renderProductList();
        }
        function updateArrayItem(key, arrayIndex, field, value) {
            if(field === 'price') value = parseInt(value) || 0;
            shopData[currentBrand].products[currentProductIndex][key][arrayIndex][field] = value;
            // Wenn Namen ge√§ndert werden, muss das Dropdown beim n√§chsten Mal upgedatet werden
            if(field === 'name') renderInventoryTable(shopData[currentBrand].products[currentProductIndex]); 
            if(key === 'colors' && field === 'hex') loadEditor(currentBrand, currentProductIndex);
        }
        function removeArrayItem(key, arrayIndex) {
            shopData[currentBrand].products[currentProductIndex][key].splice(arrayIndex, 1);
            loadEditor(currentBrand, currentProductIndex);
        }
        function addItem(key) {
            const emptyItem = { name: "Neu", price: 0 };
            if(key === 'colors') emptyItem.hex = "#000000";
            if(!shopData[currentBrand].products[currentProductIndex][key]) shopData[currentBrand].products[currentProductIndex][key] = [];
            shopData[currentBrand].products[currentProductIndex][key].push(emptyItem);
            loadEditor(currentBrand, currentProductIndex);
        }
        function addNewProduct() {
            const brand = document.getElementById('brand-select').value || Object.keys(shopData)[0];
            if(!brand) return alert("Keine Marke vorhanden!");
            const newProd = {
                id: generateId('MOD'),
                name: "Neues Modell", basePrice: 0, img: "",
                opticalConditions: [{name:"Gut", price:0}], 
                batteryConditions: [{name:"80%+", price:0}], 
                storageOptions: [{name:"64GB", price:0}], 
                colors: [{name:"Schwarz", hex:"#000", price:0}],
                inventory: []
            };
            shopData[brand].products.push(newProd);
            renderProductList();
            loadEditor(brand, shopData[brand].products.length - 1);
        }
        function generateId(prefix) { return (prefix || '') + Math.floor(1000 + Math.random() * 9000); }
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }
        function deleteProduct() {
            if(confirm("Ganzes Modell l√∂schen?")) {
                shopData[currentBrand].products.splice(currentProductIndex, 1);
                document.getElementById('editor').classList.remove('active');
                renderProductList();
            }
        }
        async function saveToServer() {
            const btn = document.querySelector('.btn-save');
            const originalText = btn.innerText;
            btn.innerText = "Speichere...";
            try {
                const res = await fetch('/api/admin/data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(shopData)
                });
                if(res.ok) {
                    btn.innerText = "Gespeichert!";
                    btn.style.background = "#28a745";
                    setTimeout(() => { btn.innerText = originalText; btn.style.background = ""; }, 2000);
                } else { alert("Fehler"); }
            } catch(e) { alert("Verbindung fehlgeschlagen"); }
        }
    </script>
</body>
</html>