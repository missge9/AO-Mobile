<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bestellverwaltung | AO Mobile Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f4f7f6; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: 0 auto; }
        
        /* Header Bereich */
        .top-header { display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px; }
        h1 { color: #007bff; margin: 0; }
        
        /* Tabs Design */
        .tab-nav { display: flex; gap: 20px; border-bottom: 2px solid #ddd; margin-bottom: 30px; }
        .tab-btn { 
            padding: 15px 20px; 
            cursor: pointer; 
            font-weight: 600; 
            color: #777; 
            border-bottom: 3px solid transparent; 
            margin-bottom: -2px; /* Damit der Strich auf der Linie liegt */
            transition: 0.2s;
            display: flex; align-items: center; gap: 8px;
        }
        .tab-btn:hover { color: #555; }
        .tab-btn.active { color: #007bff; border-bottom-color: #007bff; }
        
        .counter-badge { 
            background: #eee; color: #555; padding: 2px 8px; border-radius: 10px; font-size: 12px; 
        }
        .tab-btn.active .counter-badge { background: #e3f2fd; color: #007bff; }

        /* Inhalt Bereiche */
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Bestell-Karte Design */
        .order-card { 
            background: white; border-radius: 12px; padding: 25px; margin-bottom: 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 6px solid #ccc; 
        }
        
        .status-Offen { border-left-color: #ffc107; } /* Gelb */
        .status-Versendet { border-left-color: #28a745; opacity: 0.7; } /* Gr√ºn & leicht transparent */

        .header { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .order-id { font-weight: 700; font-size: 18px; }
        .date { color: #777; font-size: 14px; }
        
        .customer-box { background: #f9f9f9; padding: 15px; border-radius: 8px; font-size: 14px; margin-bottom: 15px; border: 1px solid #eee; }
        
        .item-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .item-table td { padding: 8px 0; border-bottom: 1px solid #eee; }
        .price { font-weight: 600; color: #ea4335; text-align: right; }
        
        .footer { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; }
        .total { font-size: 18px; font-weight: 700; }
        
        .btn { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 14px; transition: 0.2s; }
        .btn-ship { background: #007bff; color: white; box-shadow: 0 4px 10px rgba(0,123,255,0.2); }
        .btn-ship:hover { background: #0056b3; transform: translateY(-1px); }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .badge-open { background: #fff3cd; color: #856404; }
        .badge-done { background: #d4edda; color: #155724; }

        .empty-state { text-align: center; padding: 50px; color: #999; }
    </style>
</head>
<body>

    <div class="container">
        <div class="top-header">
            <h1>Bestell-Eingang</h1>
            <a href="/admin" style="text-decoration:none; color:#666; font-size:14px;">‚Üê Zur√ºck zum Lager</a>
        </div>
        
        <div class="tab-nav">
            <div class="tab-btn active" onclick="switchTab('open')">
                Offene Bestellungen 
                <span id="count-open" class="counter-badge">0</span>
            </div>
            <div class="tab-btn" onclick="switchTab('shipped')">
                Versendet / Archiv
                <span id="count-shipped" class="counter-badge">0</span>
            </div>
        </div>

        <div id="tab-open" class="tab-content active">
            <div id="list-open">Lade...</div>
        </div>

        <div id="tab-shipped" class="tab-content">
            <div id="list-shipped">Lade...</div>
        </div>
    </div>

    <script>
        async function loadOrders() {
            const res = await fetch('/api/admin/orders');
            const orders = await res.json();
            
            const listOpen = document.getElementById('list-open');
            const listShipped = document.getElementById('list-shipped');
            
            listOpen.innerHTML = '';
            listShipped.innerHTML = '';

            let countOpen = 0;
            let countShipped = 0;

            orders.forEach(order => {
                const isShipped = order.status === 'Versendet';
                
                // Z√§hler hochz√§hlen
                if (isShipped) countShipped++;
                else countOpen++;

                // Items Liste bauen
                let itemsHtml = '';
                order.items.forEach(item => {
                    itemsHtml += `
                        <tr>
                            <td width="60"><span style="background:#e3f2fd; color:#007bff; padding:2px 5px; border-radius:4px; font-size:11px;">#${item.id}</span></td>
                            <td>
                                <b>${item.name}</b> <br> 
                                <span style="color:#777; font-size:12px;">${item.options.color}, ${item.options.storage}, ${item.options.condition}</span>
                            </td>
                            <td class="price">${item.price} CHF</td>
                        </tr>
                    `;
                });

                // Adresse
                const cust = order.customer;
                const address = `${cust.street || ''}, ${cust.city || ''}`;

                // HTML Karte
                const html = `
                    <div class="order-card status-${order.status}">
                        <div class="header">
                            <div>
                                <span class="order-id">${order.order_id}</span>
                                ${isShipped ? '<span class="badge badge-done">Versendet</span>' : '<span class="badge badge-open">Offen</span>'}
                            </div>
                            <span class="date">${order.date}</span>
                        </div>

                        <div class="customer-box">
                            <div style="margin-bottom:5px;"><strong>Kunde:</strong> ${cust.username} <span style="color:#777;">(${cust.email})</span></div>
                            <div><strong>Lieferadresse:</strong> ${address}</div>
                        </div>

                        <table class="item-table">
                            ${itemsHtml}
                        </table>

                        <div class="footer">
                            <div class="total">Total: ${order.total} CHF</div>
                            ${!isShipped ? 
                                `<button class="btn btn-ship" onclick="markShipped('${order.order_id}')">üì¶ Als Versendet markieren</button>` : 
                                '<div style="color:#28a745; font-weight:600;">‚úÖ Am ' + (order.shipped_date || 'k√ºrzlich') + ' versendet</div>'
                            }
                        </div>
                    </div>
                `;

                // In den richtigen Container einf√ºgen
                if (isShipped) {
                    listShipped.innerHTML += html;
                } else {
                    listOpen.innerHTML += html;
                }
            });

            // Empty States (Falls Listen leer sind)
            if (countOpen === 0) listOpen.innerHTML = '<div class="empty-state">üéâ Alles erledigt! Keine offenen Bestellungen.</div>';
            if (countShipped === 0) listShipped.innerHTML = '<div class="empty-state">Noch keine Bestellungen im Archiv.</div>';

            // Z√§hler im Tab aktualisieren
            document.getElementById('count-open').innerText = countOpen;
            document.getElementById('count-shipped').innerText = countShipped;
        }

        async function markShipped(id) {
            if(!confirm("Bestellung wirklich als VERSENDET markieren?\nSie wird dann ins Archiv verschoben.")) return;
            
            await fetch('/api/admin/orders', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ order_id: id, status: 'Versendet' })
            });
            
            // Seite neu laden (bzw. Daten neu holen), damit die Karte verschwindet
            loadOrders();
        }

        // Tab Switching Logik
        function switchTab(tabName) {
            // Alle Inhalte ausblenden
            document.getElementById('tab-open').classList.remove('active');
            document.getElementById('tab-shipped').classList.remove('active');
            
            // Alle Tabs deaktivieren
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(b => b.classList.remove('active'));

            // Gew√§hlten Tab aktivieren
            document.getElementById('tab-' + tabName).classList.add('active');
            
            // Button Highlight setzen (etwas tricky weil wir onclick nutzen, wir suchen das Element einfach)
            // Einfacher: Wir nutzen event.currentTarget
            event.currentTarget.classList.add('active');
        }

        // Start
        loadOrders();
    </script>
</body>
</html>